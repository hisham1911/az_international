name: Deploy Frontend to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 1. Go to the project directory (where .git exists)
          cd /home/projects/az-international

          # 2. Pull latest changes
          git pull origin main

          # 3. Build in the current directory (project root)
          npm install
          npm run build

          # 4. Copy build to serving directory (if separated) OR just restart if serving from here
          # Assuming we are serving from /var/www/frontend, we copy the build
          # mkdir -p /var/www/frontend
          # cp -r .next/static /var/www/frontend/.next/
          # cp -r public /var/www/frontend/
          
          # OR simpler: if you are serving directly from this folder, just restart
          # For now, let's assume we build IN PLACE or copy everything
          
          # Let's try the safest approach based on the guide:
          # Re-copy everything to /var/www/frontend
          rsync -av --delete ./ /var/www/frontend/ --exclude .git --exclude node_modules
          
          # Navigate to var/www to install deps and finalize
          cd /var/www/frontend
          npm install --production
          
          # 5. Restart the CORRECT service name (frontend, not az-frontend)
          systemctl restart frontend
          
          echo "âœ… Frontend Deployed Successfully!"
